---
title: InnoDB独立表空间
date: 2022-01-23 15:11:31
tags: [mysql, innodb]
---

当我们在MySQL中创建一张表时（使用InnoDB存储引擎），MySQL会为每张表生成一个table_name.ibd文件，这个文件就是InnoDB的独立表空间，其中会存储我们后续插入等操作的全部数据，这次我们来分析一下其中的存储结构

<!-- more -->

InnoDB和磁盘打交道的单位为页，一页为16KB，也就是说操作磁盘数据大小最小为16KB，每个页中都存储着我们的数据信息，合起来就是整个表的数据。但是全部以页为单位进行管理的话，在表很大时，页的数量太多，不好管理，就像一个公司，人数少时可以没有层级关系，但是当人数达到一定程度时，则就会需要层级关系来便于管理，同时我们也希望相关的数据页（如某个索引的叶子结点）能挨着或者离的近一些，这样在访问的时候能加快访问速度等

我们可以分配一个固定大小的区域，其中存储一定数量的页，这个区域中页的数据是有关联关系的，对应InnoDB提出了区的概念，一个区有64个页面，这样一个区的大小是（16KB * 64）1M，这样我们可以以区为单位进行申请使用，相关的数据尽量放到一个段中。因为InnoDB是聚簇索引，没有单独的数据存储，所以在InnoDB中相关的数据基本就是各个索引了，我们可以让每个索引单独使用一些区，互不影响，每个索引使用的区域集合构成一个链表，同时考虑到InnoDB的索引为B+树，其中的叶子结点比较特殊是互相形成链表关联的，进而我们可以把一个索引的区再次拆分一下，分成一个叶子结点构成的区集合和一个非叶子结点构成的区集合，这个每个区的集合，我们可以给他们一个名字，叫做段，这样一个索引就有两个段（叶子结点段和非叶子结点段）

但是因为区的空间很大，在数据量很少时，给一个索引分配整个区的空间有点浪费，所以可以先维护一个公共的区空间，不同的索引都可以在其中申请页，当使用达到一定程度（32个页面）时，再为其中的数据分配单独的区

这样使用的时候，我们沿着公共区的链表依次查找，如果有可用空间就进行申请使用，全都没有可用空间的话则申请新的区进行使用，这时有一个问题是如何快速查找的问题，InnoDB的解决方式将链表分组，原来的一个链表根据使用状态分为了：空闲区的链表、有可用空间区的链表和空间已满的区的链表，这样使用的时候可以直接去有空闲空间的区链表查找使用即可

这时我们可以得到如下的表空间的逻辑结构

<img src="/images/innodb-logic-space.jpg" />



下面再来看下对应的物理存储结构

在InnoDB中还有一个更大的单位-组，一组包含256个区

在每组的第一个页面中，会包含组里面的256个区每个区的使用信息及区中每个页的使用信息，如果区属于某个段，其中还会包含对应段的id

在表空间的第一个组的第一个段的第一个区的第一个页面尤其特殊一些，其中不仅包含每个组第一个页面都有的每个区的信息，还会包含表空间的一些信息

1. 表空间的三种区链表（空间、可用、已满）头的信息
2. 表空间中段信息的头部节点信息
3. 还有每个段的信息（段id、段对应的三种状态区的链表表头信息，以及段使用的零散页面信息）

<img src="/images/innodb-physics-space.jpg" />



以上，如有错误，欢迎指正

